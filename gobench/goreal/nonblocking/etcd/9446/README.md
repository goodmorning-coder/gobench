
# GoReal

| Bug ID|  Ref | Patch | Type | SubType | SubsubType |
| ----  | ---- | ----  | ---- | ---- | ---- |
|[etcd#9446]|[pull request]|[patch]| NonBlocking | Traditional | Data Race |

[etcd#9446]:(etcd9446_test.go)
[patch]:https://github.com/etcd-io/etcd/pull/9446/files
[pull request]:https://github.com/etcd-io/etcd/pull/9446
 

## Backtrace

```
Write at 0x00c0005e35d8 by goroutine 124:
  github.com/coreos/etcd/mvcc/backend.(*txBuffer).reset()
      /go/src/github.com/coreos/etcd/mvcc/backend/tx_buffer.go:33 +0xab
  github.com/coreos/etcd/mvcc/backend.(*backend).defrag()
      /go/src/github.com/coreos/etcd/mvcc/backend/read_tx.go:117 +0x7d6
  github.com/coreos/etcd/mvcc/backend.(*backend).Defrag()
      /go/src/github.com/coreos/etcd/mvcc/backend/backend.go:293 +0x38
  github.com/coreos/etcd/etcdserver/api/v3rpc.(*maintenanceServer).Defragment()
      /go/src/github.com/coreos/etcd/etcdserver/api/v3rpc/maintenance.go:72 +0xb8
  github.com/coreos/etcd/etcdserver/api/v3rpc.(*authMaintenanceServer).Defragment()
      /go/src/github.com/coreos/etcd/etcdserver/api/v3rpc/maintenance.go:205 +0xe6
  github.com/coreos/etcd/etcdserver/etcdserverpb._Maintenance_Defragment_Handler.func1()
      /go/src/github.com/coreos/etcd/etcdserver/etcdserverpb/rpc.pb.go:4166 +0xa1
  github.com/coreos/etcd/vendor/github.com/grpc-ecosystem/go-grpc-prometheus.(*ServerMetrics).UnaryServerInterceptor.func1()
      /go/src/github.com/coreos/etcd/vendor/github.com/grpc-ecosystem/go-grpc-prometheus/server_metrics.go:112 +0xf9
  github.com/coreos/etcd/etcdserver/api/v3rpc.newUnaryInterceptor.func1()
      /go/src/github.com/coreos/etcd/etcdserver/api/v3rpc/interceptor.go:57 +0x135
  github.com/coreos/etcd/etcdserver/etcdserverpb._Maintenance_Defragment_Handler()
      /go/src/github.com/coreos/etcd/etcdserver/etcdserverpb/rpc.pb.go:4168 +0x1cc
  github.com/coreos/etcd/vendor/google.golang.org/grpc.(*Server).processUnaryRPC()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/server.go:843 +0x1010
  github.com/coreos/etcd/vendor/google.golang.org/grpc.(*Server).handleStream()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/server.go:1040 +0x1337
  github.com/coreos/etcd/vendor/google.golang.org/grpc.(*Server).serveStreams.func1.1()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/server.go:589 +0xc8

Previous read at 0x00c0005e35d8 by goroutine 125:
  github.com/coreos/etcd/mvcc/backend.(*bucketBuffer).Range()
      /go/src/github.com/coreos/etcd/mvcc/backend/tx_buffer.go:109 +0xc7
  github.com/coreos/etcd/mvcc/backend.(*txReadBuffer).Range()
      /go/src/github.com/coreos/etcd/mvcc/backend/tx_buffer.go:79 +0x14f
  github.com/coreos/etcd/mvcc/backend.(*readTx).UnsafeRange()
      /go/src/github.com/coreos/etcd/mvcc/backend/read_tx.go:63 +0x114
  github.com/coreos/etcd/mvcc.(*storeTxnRead).rangeKeys()
      /go/src/github.com/coreos/etcd/mvcc/kvstore_txn.go:140 +0x58e
  github.com/coreos/etcd/mvcc.(*storeTxnRead).Range()
      /go/src/github.com/coreos/etcd/mvcc/kvstore_txn.go:45 +0xe4
  github.com/coreos/etcd/mvcc.(*txnReadWrite).Range()
      <autogenerated>:1 +0xf4
  github.com/coreos/etcd/mvcc.(*metricsTxnWrite).Range()
      /go/src/github.com/coreos/etcd/mvcc/metrics_txn.go:36 +0x12a
  github.com/coreos/etcd/etcdserver.(*applierV3backend).Range()
      /go/src/github.com/coreos/etcd/etcdserver/apply.go:268 +0x325
  github.com/coreos/etcd/etcdserver.(*EtcdServer).Range.func2()
      /go/src/github.com/coreos/etcd/etcdserver/v3_server.go:101 +0x9d
  github.com/coreos/etcd/etcdserver.(*EtcdServer).doSerialize()
      /go/src/github.com/coreos/etcd/etcdserver/v3_server.go:537 +0x137
  github.com/coreos/etcd/etcdserver.(*EtcdServer).Range()
      /go/src/github.com/coreos/etcd/etcdserver/v3_server.go:102 +0x1d4
  github.com/coreos/etcd/etcdserver/api/v3rpc.(*kvServer).Range()
      /go/src/github.com/coreos/etcd/etcdserver/api/v3rpc/key.go:52 +0xb0
  github.com/coreos/etcd/etcdserver/api/v3rpc.(*quotaKVServer).Range()
      <autogenerated>:1 +0x87
  github.com/coreos/etcd/etcdserver/etcdserverpb._KV_Range_Handler.func1()
      /go/src/github.com/coreos/etcd/etcdserver/etcdserverpb/rpc.pb.go:3349 +0xa1
  github.com/coreos/etcd/vendor/github.com/grpc-ecosystem/go-grpc-prometheus.(*ServerMetrics).UnaryServerInterceptor.func1()
      /go/src/github.com/coreos/etcd/vendor/github.com/grpc-ecosystem/go-grpc-prometheus/server_metrics.go:112 +0xf9
  github.com/coreos/etcd/etcdserver/api/v3rpc.newUnaryInterceptor.func1()
      /go/src/github.com/coreos/etcd/etcdserver/api/v3rpc/interceptor.go:57 +0x135
  github.com/coreos/etcd/etcdserver/etcdserverpb._KV_Range_Handler()
      /go/src/github.com/coreos/etcd/etcdserver/etcdserverpb/rpc.pb.go:3351 +0x1d8
  github.com/coreos/etcd/vendor/google.golang.org/grpc.(*Server).processUnaryRPC()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/server.go:843 +0x1010
  github.com/coreos/etcd/vendor/google.golang.org/grpc.(*Server).handleStream()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/server.go:1040 +0x1337
  github.com/coreos/etcd/vendor/google.golang.org/grpc.(*Server).serveStreams.func1.1()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/server.go:589 +0xc8

Goroutine 124 (running) created at:
  github.com/coreos/etcd/vendor/google.golang.org/grpc.(*Server).serveStreams.func1()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/server.go:587 +0xb8
  github.com/coreos/etcd/vendor/google.golang.org/grpc/transport.(*http2Server).operateHeaders()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/transport/http2_server.go:374 +0x13c8
  github.com/coreos/etcd/vendor/google.golang.org/grpc/transport.(*http2Server).HandleStreams()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/transport/http2_server.go:406 +0x328
  github.com/coreos/etcd/vendor/google.golang.org/grpc.(*Server).serveStreams()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/server.go:585 +0x239
  github.com/coreos/etcd/vendor/google.golang.org/grpc.(*Server).handleRawConn()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/server.go:546 +0x798

Goroutine 125 (finished) created at:
  github.com/coreos/etcd/vendor/google.golang.org/grpc.(*Server).serveStreams.func1()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/server.go:587 +0xb8
  github.com/coreos/etcd/vendor/google.golang.org/grpc/transport.(*http2Server).operateHeaders()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/transport/http2_server.go:374 +0x13c8
  github.com/coreos/etcd/vendor/google.golang.org/grpc/transport.(*http2Server).HandleStreams()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/transport/http2_server.go:406 +0x328
  github.com/coreos/etcd/vendor/google.golang.org/grpc.(*Server).serveStreams()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/server.go:585 +0x239
  github.com/coreos/etcd/vendor/google.golang.org/grpc.(*Server).handleRawConn()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/server.go:546 +0x798
```

```
Write at 0x00c0001215c0 by goroutine 124:
  runtime.mapdelete_faststr()
      /usr/local/go/src/runtime/map_faststr.go:297 +0x0
  github.com/coreos/etcd/mvcc/backend.(*txBuffer).reset()
      /go/src/github.com/coreos/etcd/mvcc/backend/tx_buffer.go:31 +0x18d
  github.com/coreos/etcd/mvcc/backend.(*backend).defrag()
      /go/src/github.com/coreos/etcd/mvcc/backend/read_tx.go:117 +0x7d6
  github.com/coreos/etcd/mvcc/backend.(*backend).Defrag()
      /go/src/github.com/coreos/etcd/mvcc/backend/backend.go:293 +0x38
  github.com/coreos/etcd/etcdserver/api/v3rpc.(*maintenanceServer).Defragment()
      /go/src/github.com/coreos/etcd/etcdserver/api/v3rpc/maintenance.go:72 +0xb8
  github.com/coreos/etcd/etcdserver/api/v3rpc.(*authMaintenanceServer).Defragment()
      /go/src/github.com/coreos/etcd/etcdserver/api/v3rpc/maintenance.go:205 +0xe6
  github.com/coreos/etcd/etcdserver/etcdserverpb._Maintenance_Defragment_Handler.func1()
      /go/src/github.com/coreos/etcd/etcdserver/etcdserverpb/rpc.pb.go:4166 +0xa1
  github.com/coreos/etcd/vendor/github.com/grpc-ecosystem/go-grpc-prometheus.(*ServerMetrics).UnaryServerInterceptor.func1()
      /go/src/github.com/coreos/etcd/vendor/github.com/grpc-ecosystem/go-grpc-prometheus/server_metrics.go:112 +0xf9
  github.com/coreos/etcd/etcdserver/api/v3rpc.newUnaryInterceptor.func1()
      /go/src/github.com/coreos/etcd/etcdserver/api/v3rpc/interceptor.go:57 +0x135
  github.com/coreos/etcd/etcdserver/etcdserverpb._Maintenance_Defragment_Handler()
      /go/src/github.com/coreos/etcd/etcdserver/etcdserverpb/rpc.pb.go:4168 +0x1cc
  github.com/coreos/etcd/vendor/google.golang.org/grpc.(*Server).processUnaryRPC()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/server.go:843 +0x1010
  github.com/coreos/etcd/vendor/google.golang.org/grpc.(*Server).handleStream()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/server.go:1040 +0x1337
  github.com/coreos/etcd/vendor/google.golang.org/grpc.(*Server).serveStreams.func1.1()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/server.go:589 +0xc8

Previous read at 0x00c0001215c0 by goroutine 125:
  runtime.mapaccess1_faststr()
      /usr/local/go/src/runtime/map_faststr.go:12 +0x0
  github.com/coreos/etcd/mvcc/backend.(*txReadBuffer).Range()
      /go/src/github.com/coreos/etcd/mvcc/backend/tx_buffer.go:78 +0xc1
  github.com/coreos/etcd/mvcc/backend.(*readTx).UnsafeRange()
      /go/src/github.com/coreos/etcd/mvcc/backend/read_tx.go:63 +0x114
  github.com/coreos/etcd/mvcc.(*storeTxnRead).rangeKeys()
      /go/src/github.com/coreos/etcd/mvcc/kvstore_txn.go:140 +0x58e
  github.com/coreos/etcd/mvcc.(*storeTxnRead).Range()
      /go/src/github.com/coreos/etcd/mvcc/kvstore_txn.go:45 +0xe4
  github.com/coreos/etcd/mvcc.(*txnReadWrite).Range()
      <autogenerated>:1 +0xf4
  github.com/coreos/etcd/mvcc.(*metricsTxnWrite).Range()
      /go/src/github.com/coreos/etcd/mvcc/metrics_txn.go:36 +0x12a
  github.com/coreos/etcd/etcdserver.(*applierV3backend).Range()
      /go/src/github.com/coreos/etcd/etcdserver/apply.go:268 +0x325
  github.com/coreos/etcd/etcdserver.(*EtcdServer).Range.func2()
      /go/src/github.com/coreos/etcd/etcdserver/v3_server.go:101 +0x9d
  github.com/coreos/etcd/etcdserver.(*EtcdServer).doSerialize()
      /go/src/github.com/coreos/etcd/etcdserver/v3_server.go:537 +0x137
  github.com/coreos/etcd/etcdserver.(*EtcdServer).Range()
      /go/src/github.com/coreos/etcd/etcdserver/v3_server.go:102 +0x1d4
  github.com/coreos/etcd/etcdserver/api/v3rpc.(*kvServer).Range()
      /go/src/github.com/coreos/etcd/etcdserver/api/v3rpc/key.go:52 +0xb0
  github.com/coreos/etcd/etcdserver/api/v3rpc.(*quotaKVServer).Range()
      <autogenerated>:1 +0x87
  github.com/coreos/etcd/etcdserver/etcdserverpb._KV_Range_Handler.func1()
      /go/src/github.com/coreos/etcd/etcdserver/etcdserverpb/rpc.pb.go:3349 +0xa1
  github.com/coreos/etcd/vendor/github.com/grpc-ecosystem/go-grpc-prometheus.(*ServerMetrics).UnaryServerInterceptor.func1()
      /go/src/github.com/coreos/etcd/vendor/github.com/grpc-ecosystem/go-grpc-prometheus/server_metrics.go:112 +0xf9
  github.com/coreos/etcd/etcdserver/api/v3rpc.newUnaryInterceptor.func1()
      /go/src/github.com/coreos/etcd/etcdserver/api/v3rpc/interceptor.go:57 +0x135
  github.com/coreos/etcd/etcdserver/etcdserverpb._KV_Range_Handler()
      /go/src/github.com/coreos/etcd/etcdserver/etcdserverpb/rpc.pb.go:3351 +0x1d8
  github.com/coreos/etcd/vendor/google.golang.org/grpc.(*Server).processUnaryRPC()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/server.go:843 +0x1010
  github.com/coreos/etcd/vendor/google.golang.org/grpc.(*Server).handleStream()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/server.go:1040 +0x1337
  github.com/coreos/etcd/vendor/google.golang.org/grpc.(*Server).serveStreams.func1.1()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/server.go:589 +0xc8

Goroutine 124 (running) created at:
  github.com/coreos/etcd/vendor/google.golang.org/grpc.(*Server).serveStreams.func1()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/server.go:587 +0xb8
  github.com/coreos/etcd/vendor/google.golang.org/grpc/transport.(*http2Server).operateHeaders()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/transport/http2_server.go:374 +0x13c8
  github.com/coreos/etcd/vendor/google.golang.org/grpc/transport.(*http2Server).HandleStreams()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/transport/http2_server.go:406 +0x328
  github.com/coreos/etcd/vendor/google.golang.org/grpc.(*Server).serveStreams()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/server.go:585 +0x239
  github.com/coreos/etcd/vendor/google.golang.org/grpc.(*Server).handleRawConn()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/server.go:546 +0x798

Goroutine 125 (finished) created at:
  github.com/coreos/etcd/vendor/google.golang.org/grpc.(*Server).serveStreams.func1()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/server.go:587 +0xb8
  github.com/coreos/etcd/vendor/google.golang.org/grpc/transport.(*http2Server).operateHeaders()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/transport/http2_server.go:374 +0x13c8
  github.com/coreos/etcd/vendor/google.golang.org/grpc/transport.(*http2Server).HandleStreams()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/transport/http2_server.go:406 +0x328
  github.com/coreos/etcd/vendor/google.golang.org/grpc.(*Server).serveStreams()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/server.go:585 +0x239
  github.com/coreos/etcd/vendor/google.golang.org/grpc.(*Server).handleRawConn()
      /go/src/github.com/coreos/etcd/vendor/google.golang.org/grpc/server.go:546 +0x798
```