
# GoReal

| Bug ID|  Ref | Patch | Type | SubType | SubsubType |
| ----  | ---- | ----  | ---- | ---- | ---- |
|[etcd#11982]|[pull request]|[patch]| NonBlocking | Traditional | Data Race |

[etcd#11982]:(etcd11982_test.go)
[patch]:https://github.com/etcd-io/etcd/pull/11982/files
[pull request]:https://github.com/etcd-io/etcd/pull/11982
 

## Backtrace

```
Write at 0x00c0000b6008 by goroutine 316:
  sync/atomic.AddInt64()
      /usr/local/go/src/runtime/race_amd64.s:276 +0xb
  go.etcd.io/etcd/v3/etcdserver/api/v2store.(*Stats).Inc()
      /go/src/go.etcd.io/etcd/etcdserver/api/v2store/stats.go:129 +0x223
  go.etcd.io/etcd/v3/etcdserver/api/v2store.(*store).Get.func1()
      /go/src/go.etcd.io/etcd/etcdserver/api/v2store/store.go:139 +0x76
  go.etcd.io/etcd/v3/etcdserver/api/v2store.(*store).Get()
      /go/src/go.etcd.io/etcd/etcdserver/api/v2store/store.go:149 +0x4ff
  go.etcd.io/etcd/v3/etcdserver.(*reqV2HandlerStore).Get()
      /go/src/go.etcd.io/etcd/etcdserver/v2_server.go:71 +0x2e7
  go.etcd.io/etcd/v3/etcdserver.(*reqV2HandlerEtcdServer).Get()
      <autogenerated>:1 +0xad
  go.etcd.io/etcd/v3/etcdserver.(*RequestV2).Handle()
      /go/src/go.etcd.io/etcd/etcdserver/v2_server.go:155 +0x2c2
  go.etcd.io/etcd/v3/etcdserver.(*EtcdServer).Do()
      /go/src/go.etcd.io/etcd/etcdserver/v2_server.go:131 +0x2b2
  go.etcd.io/etcd/v3/etcdserver/api/v2auth.(*store).requestResource()
      /go/src/go.etcd.io/etcd/etcdserver/api/v2auth/auth_requests.go:132 +0x294
  go.etcd.io/etcd/v3/etcdserver/api/v2auth.(*store).detectAuth()
      /go/src/go.etcd.io/etcd/etcdserver/api/v2auth/auth_requests.go:93 +0x8f
  go.etcd.io/etcd/v3/etcdserver/api/v2auth.(*store).AuthEnabled()
      /go/src/go.etcd.io/etcd/etcdserver/api/v2auth/auth.go:365 +0x38
  go.etcd.io/etcd/v3/etcdserver/api/v2http.hasKeyPrefixAccess()
      /go/src/go.etcd.io/etcd/etcdserver/api/v2http/client_auth.go:127 +0x65
  go.etcd.io/etcd/v3/etcdserver/api/v2http.(*keysHandler).ServeHTTP()
      /go/src/go.etcd.io/etcd/etcdserver/api/v2http/client.go:137 +0x59e
  net/http.(*ServeMux).ServeHTTP()
      /usr/local/go/src/net/http/server.go:2416 +0x288
  go.etcd.io/etcd/v3/etcdserver/api/v2http.requestLogger.func1()
      /go/src/go.etcd.io/etcd/etcdserver/api/v2http/http.go:80 +0x8e
  net/http.HandlerFunc.ServeHTTP()
      /usr/local/go/src/net/http/server.go:2041 +0x51
  net/http.serverHandler.ServeHTTP()
      /usr/local/go/src/net/http/server.go:2836 +0xce
  net/http.(*conn).serve()
      /usr/local/go/src/net/http/server.go:1924 +0x837

Previous read at 0x00c0000b6008 by goroutine 155:
  go.etcd.io/etcd/v3/etcdserver/api/v2store.(*Stats).clone()
      /go/src/go.etcd.io/etcd/etcdserver/api/v2store/stats.go:89 +0x605
  go.etcd.io/etcd/v3/etcdserver/api/v2store.(*store).Clone()
      /go/src/go.etcd.io/etcd/etcdserver/api/v2store/store.go:764 +0x57c
  go.etcd.io/etcd/v3/etcdserver.(*EtcdServer).snapshot()
      /go/src/go.etcd.io/etcd/etcdserver/server.go:2137 +0xb8
  go.etcd.io/etcd/v3/etcdserver.(*EtcdServer).triggerSnapshot()
      /go/src/go.etcd.io/etcd/etcdserver/server.go:1224 +0x63c
  go.etcd.io/etcd/v3/etcdserver.(*EtcdServer).applyAll()
      /go/src/go.etcd.io/etcd/etcdserver/server.go:1041 +0x200
  go.etcd.io/etcd/v3/etcdserver.(*EtcdServer).run.func8()
      /go/src/go.etcd.io/etcd/etcdserver/server.go:985 +0x53
  go.etcd.io/etcd/v3/pkg/schedule.(*fifo).run()
      /go/src/go.etcd.io/etcd/pkg/schedule/schedule.go:157 +0x11e

Goroutine 316 (running) created at:
  net/http.(*Server).Serve()
      /usr/local/go/src/net/http/server.go:2962 +0x5b6
  net/http/httptest.(*Server).goServe.func1()
      /usr/local/go/src/net/http/httptest/server.go:308 +0xd3

Goroutine 155 (running) created at:
  go.etcd.io/etcd/v3/pkg/schedule.NewFIFOScheduler()
      /go/src/go.etcd.io/etcd/pkg/schedule/schedule.go:70 +0x2b1
  go.etcd.io/etcd/v3/etcdserver.(*EtcdServer).run()
      /go/src/go.etcd.io/etcd/etcdserver/server.go:870 +0x32c
```

